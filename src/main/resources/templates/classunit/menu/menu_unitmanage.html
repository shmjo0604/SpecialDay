<div th:fragment="menu_unitmanage">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/fullcalendar@5.7.0/main.min.js"></script>
    <!-- full calendar -->
    <script th:src=@{/js/classunit/index.global.js}></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.css">
    <!-- fullcalendar 언어 설정관련 script -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/locales-all.js"></script>
    <!-- jquery -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!-- css -->
    <link rel="stylesheet" th:href="@{/css/jquery-ui.min.css}">
    <link rel="stylesheet" th:href="@{/css/classunit/menu_unitmanage.css}">
    <!--google-font-->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@500&display=swap" rel="stylesheet">  

    <style>
        body {
            padding: 0;
            font-family: Arial, Helvetica Neue, Helvetica, sans-serif;
            font-size: 14px;
        }

        #calendar {
            max-width: 1100px;
            margin: 0 auto;
        }

        /* 오른쪽 사이드바 */
        .show-right-side-bar-btn {
            float: right;
        }

        #right-side-bar {
            position: fixed;
            top: 0;
            right: -350px;
            width: 350px;
            height: 100%;
            background-color: rgb(204, 228, 119);
            transition: right 0.5s, background-color 0.5s;
            z-index: 9999;
        }

        #right-side-bar.active {
            right: 0;
            background-color: rgb(237, 243, 235);
        }

        #right-side-bar-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            display: none;
        }

        #closeButton {
            cursor: pointer;
        }

        /* 달력 날짜 */
        .fc-day-sun a {
            color: red;
            text-decoration: none;
        }

        .fc-day-mon a {
            color: black;
            text-decoration: none;
        }

        .fc-day-tue a {
            color: black;
            text-decoration: none;
        }

        .fc-day-wed a {
            color: black;
            text-decoration: none;
        }

        .fc-day-thu a {
            color: black;
            text-decoration: none;
        }

        .fc-day-fri a {
            color: black;
            text-decoration: none;
        }

        .fc-day-sat a {
            color: blue;
            text-decoration: none;
        }

        /*달력 이벤트*/
        .fc-event-title.fc-sticky{
            font-family: 'Noto Sans KR', sans-serif;
        }
        
        /* 달력 헤더 */
        .fc-header-toolbar {
            font-family: 'Noto Sans KR', sans-serif;
          }
        
    </style>
    <div>
        <div id='calendar' style="margin-top: 20px;"></div>
    </div>
    

    <div id="right-side-bar">
        <div style="margin: 20px;">
            
            <div class="sidevar-header" style="display: inline-block; width: 100%;">
                <div id="closeButton"><i class="fa-solid fa-x" style="float: left; margin-top: 5px;"></i></div>
                <div style="font-weight: bold; font-size: large; margin-left: 10px; float: left;">전체 일정</div>
                <div style="float: right;"><input type="button" value="일정 전체 삭제" class="btn btn-sm btn-secondary"
                        id="all_delete"></div><br />
            </div>
            <hr />
            <div class="sidevar-body">
                <div class="unit-list" style="margin-top: 5px;"></div>
            </div>
        </div>
    </div>
    <div id="right-side-bar-bg"></div>

    <style>
        .modal-dialog {
            max-width: 800px;
            margin: 1.75rem auto;
        }

        .modal-content {
            height: 550px;
            overflow-y: auto;
        }

        .flex-container {
            display: flex;
        }

        .vertical-line {
            flex-grow: 1;
            position: relative;
        }

        .vertical-line::before {
            content: "";
            position: absolute;
            top: 0;
            bottom: 0;
            left: 50%;
            /* 가운데로 위치 조정 */
            border-left: 1px solid #ccc;
            /* 세로선 스타일 및 색상 설정 */
        }

        input::placeholder {
            font-size: small;
            font-weight: lighter;
        }

        .btn:hover { background-color: rgb(245, 245, 245);}
    </style>

    <!-- 일정 등록 modal -->
    <div class="modal fade" id="unitInsertModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header"  style="background-color: rgb(45, 187, 140); height: 55px;">
                    <h5 class="modal-title" id="exampleModalLabel" style="font-family: 'Noto Sans KR', sans-serif; color: white;"><i class="fa-regular fa-calendar" style="color: white;"></i> 클래스 일정을 등록하세요.</h5>
                    <button type="button" class="close" onclick="cancel()"
                        style="border: none; background-color: rgb(45, 187, 140); font-size: xx-large; color: white;">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group flex-container" style="display: inline-block;">
                        <div class="row vertical-line">
                            <div class="col-md-6">
                                <input type="hidden" class="form-control" id="classcode" th:value="${classcode}"
                                    name="classcode">

                                <div class="row" style=" margin-bottom: 10px; margin-top: 10px;">
                                    <div class="col-sm-3" style="width: 100%;">
                                        <label for="classdate" class="col-form-label">날짜<h6 style="display:inline; color: #FF8E8E">(필수)</h6></label>
                                        <input class="form-control datepicker date" id="classdate" name="classdate" placeholder="클래스 진행 날짜를 입력하세요." value="2023-07-29">
                                    </div>
                                    <input type="hidden" name="classday" id="classday" value="토요일">
                                </div>

                                <div class="row" style="margin-top: 20px;">
                                    <div class="col-sm-3" style="width: 50%;">
                                        <label for="classstart" class="col-form-label">시작 시각<h6 style="display:inline; color: #FF8E8E">(필수)</h6></label>
                                        <input type="time" class="form-control" id="classstart" name="classstart" value="13:00" >
                                    </div>
                                    <div class="col-sm-3" style="width: 50%;">
                                        <label for="classend" class="col-form-label">종료 시각<h6 style="display:inline; color: #FF8E8E">(필수)</h6></label>
                                        <input type="time" class="form-control" id="classend" name="classend" value="15:00">
                                    </div>
                                </div>

                                <div class="row" style="margin-top: 20px;">
                                    <div class="col-sm-3" style="width: 50%;">
                                        <label for="minimum" class="col-form-label">최소인원<h6 style="display:inline; color: #FF8E8E">(필수)</h6></label>
                                        <input type="number" class="form-control" id="minimum" name="minimum" placeholder="최소인원을 입력하세요." value="5">
                                    </div>
                                    <div class="col-sm-3" style="width: 50%;">
                                        <label for="maximum" class="col-form-label">최대인원<h6 style="display:inline; color: #FF8E8E">(필수)</h6></label>
                                        <input type="number" class="form-control" id="maximum" name="maximum" placeholder="최대인원을 입력하세요." value="10">
                                    </div>
                                </div>        
                            </div>
                            <div class="col-md-6">
                                <div class="col">
                                    <label
                                        style="font-size: small; margin-top: 10px; margin-bottom: 10px; background-color: antiquewhite; font-family: 'Noto Sans KR', sans-serif; text-decoration-line: underline;">
                                        <i class="fa-solid fa-user-pen"></i> 경험자 및 숙련자 대상일 경우만 추가금액을 설정할 수 있습니다.</label><br />
                                    <div class="form-check form-check-inline" style="margin-top: 10px;">
                                        <input type="radio" class="form-check-input radio-value level-value-detail"
                                            id="classlevel1" name="classlevel" value="1" checked>
                                        <label class="form-check-label" for="classlevel1">입문자</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input type="radio" class="form-check-input radio-value level-value-detail"
                                            id="classlevel2" name="classlevel" value="2">
                                        <label class="form-check-label" for="classlevel2">경험자</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input type="radio" class="form-check-input radio-value level-value-detail"
                                            id="classlevel3" name="classlevel" value="3">
                                        <label class="form-check-label" for="classlevel3">숙련자</label>
                                    </div>
                                </div>
                                <div style="width: 50%; margin-top: 10px;">
                                    <label for="defaultPrice" class="col-form-label">입문자 수강금액</label>
                                    <input type="number" class="form-control" id="defaultPrice" name="defaultPrice"
                                        th:value="${defaultPrice}" disabled readonly>
                                </div>
                                <div style="width: 100%; margin-top: 5px;">
                                    <label for="addprice" class="col-form-label">추가 금액</label>
                                    <input type="number" class="form-control" id="addprice" name="addprice" value=""
                                        disabled oninput="calculateDiscount()" style="width: 50%;" placeholder="0원">
                                </div>
                                <div style="width: 50%; margin-top: 5px;">
                                    <input type="checkbox" class="form-check-input" id="discount-chk"
                                        name="discount-chk" onchange="toggleDiscountInput()" style="margin-top: 10px;">
                                    <label for="discount" class="col-form-label" style="margin-left: 5px;">할인 비율
                                        설정(%)</label>
                                    <input type="number" class="form-control" id="discount" name="discount" value="" placeholder="0%"
                                        disabled oninput="calculateDiscount(); discountedPrice();">
                                </div>
                                <div style="width: 50%; margin-top: 5px;">
                                    <label for="discount_price" class="col-form-label">계산된 금액</label>
                                    <input type="number" class="form-control" id="discount_price" name="discount_price" placeholder="금액을 확인하세요."
                                        value="" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="d-flex justify-content-between" style="width: 100%;">
                        <div style="width: 49%;">
                            <button type="button" style="border: 1px solid rgb(207, 206, 206); width: 100%; font-family: 'Noto Sans KR', sans-serif;" class="btn btn-sm"
                                data-dismiss="modal" onclick="cancel()">닫기</button>
                        </div>
                        <div style="width: 49%;">
                            <input type="button" value="추가" style="border: 1px solid rgb(207, 206, 206); width: 100%; font-family: 'Noto Sans KR', sans-serif;"
                                class="btn btn-sm" onclick="addInspection()">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 일정 수정 modal -->
    <div class="modal fade" id="unitUpdateModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header" style="background-color: rgb(45, 187, 140); height: 55px;">
                    <h5 class="modal-title" id="exampleModalLabel" style="font-family: 'Noto Sans KR', sans-serif; color: white;"><i class="fa-regular fa-calendar" style="color: white;"></i> 변경할 내용을 입력하세요.</h5>
                    <button type="button" class="close" onclick="cancel()"
                        style="border: none; background-color: rgb(45, 187, 140); font-size: xx-large; color: white;">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group flex-container" style="display: inline-block;">
                        <div class="row vertical-line">
                            <div class="col-md-6">
                                <input type="hidden" class="form-control" id="classcode2" th:value="${classcode}">
                                <input type="hidden" id="unitno2" th:value="${no}">

                                <div class="row" style="margin-bottom: 10px; margin-top: 10px;">
                                    <div class="col-sm-3" style="width: 100%;">
                                        <label for="classdate2" class="col-form-label">날짜<h6 style="display:inline; color: #FF8E8E">(필수)</h6></label>
                                        <input class="form-control datepicker date" id="classdate2" name="classdate2" placeholder="클래스 진행 날짜를 입력하세요.">
                                    </div>
                                    <input type="hidden" name="classda2y" id="classday2">
                                </div>

                                <div class="row" style="margin-top: 20px;">
                                    <div class="col-sm-3" style="width: 50%;">
                                        <label for="classstart2" class="col-form-label">시작 시각<h6 style="display:inline; color: #FF8E8E">(필수)</h6></label>
                                        <input type="time" class="form-control" id="classstart2" name="classstart2">
                                    </div>
                                    <div class="col-sm-3" style="width: 50%;">
                                        <label for="classend2" class="col-form-label">종료 시각<h6 style="display:inline; color: #FF8E8E">(필수)</h6></label>
                                        <input type="time" class="form-control" id="classend2" name="classend2">
                                    </div>
                                </div>
                                
                                <div class="row" style="margin-top: 20px;">
                                    <div class="col-sm-3" style="width: 50%;">
                                        <label for="minimum2" class="col-form-label">최소인원<h6 style="display:inline; color: #FF8E8E">(필수)</h6></label>
                                        <input type="number" class="form-control" id="minimum2" name="minimum2" placeholder="최소인원을 입력하세요.">
                                    </div>
                                    <div class="col-sm-3" style="width: 50%;">
                                        <label for="maximum2" class="col-form-label">최대인원<h6 style="display:inline; color: #FF8E8E">(필수)</h6></label>
                                        <input type="number" class="form-control" id="maximum2" name="maximum2" placeholder="최대인원을 입력하세요.">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="col">
                                    <label
                                        style="font-size: small; margin-top: 10px; margin-bottom: 10px; background-color: antiquewhite; font-family: 'Noto Sans KR', sans-serif; text-decoration-line: underline;">
                                        <i class="fa-solid fa-user-pen"></i> 경험자 및 숙련자 대상일 경우만 추가금액을 설정할 수 있습니다.</label><br />
                                    <div class="form-check form-check-inline" style="margin-top: 10px;">
                                        <input type="radio" class="form-check-input radio-value level-value-detail"
                                            id="classlevel4" name="classlevel" value="1">
                                        <label class="form-check-label" for="classlevel1">입문자</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input type="radio" class="form-check-input radio-value level-value-detail"
                                            id="classlevel5" name="classlevel" value="2">
                                        <label class="form-check-label" for="classlevel2">경험자</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input type="radio" class="form-check-input radio-value level-value-detail"
                                            id="classlevel6" name="classlevel" value="3">
                                        <label class="form-check-label" for="classlevel3">숙련자</label>
                                    </div>
                                </div>
                                <div style="width: 50%; margin-top: 10px;">
                                    <label for="defaultPrice2" class="col-form-label">입문자 수강금액</label>
                                    <input type="number" class="form-control" id="defaultPrice2" name="defaultPrice2"
                                        disabled readonly>
                                </div>
                                <div style="width: 100%; margin-top: 5px;">
                                    <label for="addprice2" class="col-form-label">추가 금액</label>
                                    <input type="number" class="form-control" id="addprice2" name="addprice2" value=""
                                        disabled oninput="calculateDiscount2()" style="width: 50%;" placeholder="0원">
                                </div>
                                <div style="width: 50%; margin-top: 5px;">
                                    <input type="checkbox" class="form-check-input" id="discount-chk2"
                                        name="discount-chk2" onchange="toggleDiscountInput2()" style="margin-top: 10px;">
                                    <label for="discount2" class="col-form-label" style="margin-left: 5px;">할인 비율
                                        설정(%)</label>
                                    <input type="number" class="form-control" id="discount2" name="discount2" value="" placeholder="0%"
                                        disabled oninput="calculateDiscount2(); discountedPrice2();">
                                </div>
                                <div style="width: 50%; margin-top: 5px;">
                                    <label for="discount_price2" class="col-form-label">계산된 금액</label>
                                    <input type="number" class="form-control" id="discount_price2"
                                        name="discount_price2" placeholder="금액을 확인하세요." value="" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="d-flex justify-content-between" style="width: 100%;">
                        <div style="width: 49%;">
                            <button type="button" style="border: 1px solid rgb(207, 206, 206);; width: 100%; font-family: 'Noto Sans KR', sans-serif;" class="btn btn-sm"
                                data-dismiss="modal" onclick="cancel2()">닫기</button>
                        </div>
                        <div style="width: 49%;">
                            <input type="button" value="완료" style="border: 1px solid rgb(207, 206, 206);; width: 100%; font-family: 'Noto Sans KR', sans-serif;"
                                class="btn btn-sm" onclick="updateInspection()">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script th:src="@{/js/jquery-3.6.4.min.js}"></script>
    <script th:src="@{/js/jquery-ui.min.js}"></script>
    <script th:src="@{/js/classunit/menu_unitmanage.js}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.3.5/axios.min.js"></script>
    <!-- <script th:src="@{/js/axios.min.js}"></script> -->
    <script type="text/javascript" th:inline="javascript">

        // 달력에 입력할 데이터
        const list = /*[[${list}]]*/[];

        // 달력
        document.addEventListener('DOMContentLoaded', function () {
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth', // 초기 로드 될때 보이는 캘린더 화면(기본 설정: 달)
                headerToolbar: { // 헤더에 표시할 툴 바
                    start: 'prev next today',
                    center: 'title',
                    end: 'addEventButton selectEventButton'
                },
                customButtons: {
                    addEventButton: {
                        text: "일정 등록",
                        click: function () {
                            $("#unitInsertModal").modal("show");
                        }
                    },
                    selectEventButton: { // 추가한 버튼 설정
                        text: "전체 일정",  // 버튼 내용
                        click: function () { // 버튼 클릭 시 이벤트 추가
                            selectAll();
                            showRightSideBar(); // 오른쪽 사이드바를 보여주는 함수 호출

                        }
                    }
                },
                titleFormat: function (date) {
                    return date.date.year + '년 ' + (parseInt(date.date.month) + 1) + '월';
                },
                //initialDate: '2021-07-15', // 초기 날짜 설정 (설정하지 않으면 오늘 날짜가 보임)
                selectable: true, // 달력 일자 드래그 설정가능
                droppable: true,
                editable: false,  // false로 변경 시 draggable 작동 x ,
                displayEventTime: false, // 시간 표시 x
                nowIndicator: true, // 현재 시간 마크
                locale: 'ko', // 한국어 설정
                events: async function (fetchInfo, successCallback, failureCallback) {
                    try {
                        const eventObjects = await createEventObjects();
                        successCallback(eventObjects);
                    } catch (error) {
                        console.error('데이터를 가져오는 중 오류 발생 :', error);
                        failureCallback(error);
                    }
                }
            });
            calendar.render();
        });

        async function createEventObjects() {
            try {
                // REST API를 통해 일정 데이터를 가져옴
                let url = /*[[@{/api/classunit/selectunitlist.json}]]*/"";
                url += `?classcode=${ccode}`;
                const headers = { "Content-Type": "application/json" };
                const response = await axios.get(url, { headers: headers });
                const data = response.data;
                console.log(data);


                // 가져온 데이터를 이용하여 일정 객체 배열 생성
                const eventObjects = data.list.map(function (obj) {
                    console.log(obj.classday);
                    var level;
                    if (obj.classlevel === 1) {
                        level = "입문자";
                    } else if (obj.classlevel === 2) {
                        level = "경험자";
                    } else if (obj.classlevel === 3) {
                        level = "숙련자";
                    }

                    return {
                        title: obj.classstart + " ~ " + obj.classend + " " + level,
                        start: obj.classdate,
                        backgroundColor: getBackgroundColor(obj.classlevel)
                    };
                });

                return eventObjects; // 생성된 일정 객체 배열 반환
            } catch (error) {
                console.error('일정 데이터를 가져오는 중 오류가 발생했습니다:', error);
                return []; // 오류 발생 시 빈 배열 반환
            }
        }

        function getBackgroundColor(classlevel) {
            switch (classlevel) {
                case 1:
                    return "#00C783";
                case 2:
                    return "#23946C";
                case 3:
                    return "#006F4A";
            }
        }

        // 모달창 닫기 
        function cancel() {
            $("#unitInsertModal").modal("hide");
            $("#unitUpdateModal").modal("hide");
        }


        // 일정등록 유효성 검사
        function addInspection() {
            const minimum = document.getElementById("minimum").value;
            const maximum = document.getElementById("maximum").value;
            const classdate = document.getElementById("classdate").value;
            const classstart = document.getElementById("classstart").value;
            const classend = document.getElementById("classend").value;

            // 필수 입력 항목 확인
            if (!minimum || !maximum || !classdate || !classstart || !classend) {
                alert("필수 입력 항목을 모두 입력해주세요.");
                return;
            }

            // 시작시각 및 종료시각 검사
            const startDate = new Date(classdate + " " + classstart);
            const endDate = new Date(classdate + " " + classend);
            if (endDate <= startDate) {
                alert("종료 시각을 시작 시각보다 늦게 설정해주세요.");
                return;
            }

            // 최소인원 검사
            if (parseInt(minimum) <= 0) {
                alert("최소인원은 0 이상이어야 합니다.");
                return;
            }

            // 최대인원 검사
            if (parseInt(maximum) < parseInt(minimum)) {
                alert("최대인원은 최소인원 이상이어야 합니다.");
                return;
            } 

            // 유효성 검사 통과 시 일정 등록 처리
            add();

        }

        // 일정등록 
        async function add() {
            const classcode = document.getElementById("classcode").value;
            console.log(classcode);
            const min = document.getElementById("minimum").value;
            const max = document.getElementById("maximum").value;
            const date = document.getElementById("classdate").value;
            const day = document.getElementById("classday").value;
            const start = document.getElementById("classstart").value;
            const end = document.getElementById("classend").value;
            var level = document.querySelector('input[name="classlevel"]:checked').value;
            const discount = document.getElementById("discount").value;
            const addprice = document.getElementById("addprice").value;

            // POST호출
            const url = /*[[@{/api/classunit/insert.json}]]*/"";
            const headers = { "Content-Type": "application/json" };
            const body = {
                classproduct: { classcode: classcode },
                minimum: min,
                maximum: max,
                classdate: date,
                classday: day,
                classstart: start,
                classend: end,
                classlevel: level,
                discount: discount,
                addprice: addprice
            };

            // console.log(body);
            const { data } = await axios.post(url, body, { headers: headers });
            console.log('반환되는 결과', data);

            if (data.status === 200) {
                alert("일정 등록이 완료되었습니다.")
                $('#unitInsertModal').modal('hide'); // 모달 창 닫기
                location.reload();
            }
            else {
                alert("일정 등록에 실패하였습니다.");
            }
        }

        //모달 창 닫힐 때 초기화 함수 호출
        $('#unitInsertModal').on('hidden.bs.modal', function () {
            resetModalInputs();
        });

        function resetModalInputs() {
            // document.getElementById("classcode").value = "";
            document.getElementById("minimum").value = "";
            document.getElementById("maximum").value = "";
            document.getElementById("classdate").value = "";
            document.getElementById("classday").value = "";
            document.getElementById("classstart").value = "";
            document.getElementById("classend").value = "";
            document.getElementById("discount").value = "";
            document.getElementById("addprice").value = "";
            document.getElementById("discount_price").value = "";
            document.getElementById("classlevel1").checked = true;
            document.getElementById("addprice").disabled = true;
            document.getElementById("discount-chk").checked = false;
            document.getElementById("discount").disabled = true;
        }


        // 할인가만 적용한 계산
        function discountedPrice() {
            var defaultPrice = parseInt(document.getElementById("defaultPrice").value);
            var discount = parseInt(document.getElementById("discount").value);
            var discountedPrice = defaultPrice - (defaultPrice * discount / 100);
            document.getElementById("discount_price").value = discountedPrice;
        }

        // 추가음액과 할인가 적용 계산
        function calculateDiscount() {
            var defaultPrice = parseInt(document.getElementById("defaultPrice").value);
            var discount = parseInt(document.getElementById("discount").value);
            var addPrice = parseInt(document.getElementById("addprice").value);
        
            if (!addPrice) {
                discountedPrice(); // 추가금액이 없을 때 할인가만 적용한 계산 수행
              } else {
                var totalAmount = defaultPrice + addPrice;
                var discountAmount = totalAmount * (discount / 100);
                var discountPrice = totalAmount - discountAmount;
            
                document.getElementById("discount_price").value = discount ? discountPrice : totalAmount;
            }
        }
        
        // 추가금액 입력값 변경 시 계산 수행
        document.getElementById("addprice").addEventListener("input", calculateDiscount);
        
        // 할인 비율 변경 시 계산 수행
        document.getElementById("discount").addEventListener("input", calculateDiscount);

        // 할인 비율 설정시 체크 후 입력란 활성화
        function toggleDiscountInput() {
            var discountCheckbox = document.getElementById("discount-chk");
            var discountInput = document.getElementById("discount");
            var discountPriceInput = document.getElementById("discount_price");
            var addPriceInput = document.getElementById("addprice");

            if (discountCheckbox.checked) {
                discountInput.disabled = false;
            } else {
                discountInput.disabled = true;
                discountInput.value = "";
                discountPriceInput.value = "";
            }
        }

        // 클래스 난이도별 추가 금액 입력란 활성화
        var radioBtns = document.querySelectorAll('.radio-value');
        function handleRadioClick() {
            var addpriceInput = document.getElementById('addprice');
            var level = document.querySelector('input[name="classlevel"]:checked').value;
            addpriceInput.disabled = !(level === '2' || level === '3');
            addpriceInput.value = '';
        }

        radioBtns.forEach(function (radioBtn) {
            radioBtn.addEventListener('click', handleRadioClick);
        });

        // 난이도 체크가 변경될 때 discount_price 초기화
        $(document).ready(function() {
            $('input[name="classlevel"]').change(function() {
                $('#discount_price').val('');

                var isChecked = $(this).prop('checked');
                if (isChecked) {
                    $('#discount-chk').prop('checked', false);
                    $('#discount').val('');
                    $('#discount').prop('disabled', true);
                } else {
                    $('#discount-chk').prop('checked', true);
                }
            });
        });

        // *********************************************************************** 오른쪽 슬라이드 **********************************************************************************

        // 오른쪽 사이드바 열기
        function showRightSideBar() {
            var rightSideBar = document.getElementById('right-side-bar');
            var rightSideBarBg = document.getElementById('right-side-bar-bg');
            rightSideBar.classList.add('active');
            rightSideBarBg.style.display = 'block';
        }

        // 오른쪽 사이드바 닫기
        function hideRightSideBar() {
            var rightSideBar = document.getElementById('right-side-bar');
            var rightSideBarBg = document.getElementById('right-side-bar-bg');
            rightSideBar.classList.remove('active');
            rightSideBarBg.style.display = 'none';
        }

        // 닫기 버튼 클릭 이벤트 처리
        document.getElementById('closeButton').addEventListener('click', hideRightSideBar);

        // 오른쪽 사이드바 배경 클릭 시 닫기
        document.getElementById('right-side-bar-bg').addEventListener('click', hideRightSideBar);


        /*************************************************************************************/
        const ccode = /*[[${classcode}]]*/""; // ClassUnitController에서 받은 classcode

        //일정 조회
        async function selectAll() {
            const classcode = document.getElementById("classcode").value;
            // console.log(classcode);

            // GET 호출
            let url = /*[[@{/api/classunit/selectunitlist.json}]]*/"";
            url += `?classcode=${ccode}`;
            // console.log(url);
            const headers = { "Content-Type": "application/json" };
            const { data } = await axios.get(url, { headers: headers });
            console.log('반환 결과', data);

            // 기존 내용 초기화
            const unitList = document.querySelector(".unit-list");
            unitList.innerHTML = "";

            /********************************** 조회 *******************************/

            // 데이터 출력
            data.list.forEach(item => {
                const div = document.createElement("div");
                div.classList.add("unit");

                div.style.border = "1px solid rgb(201, 197, 197)";
                div.style.backgroundColor = "white";
                div.style.borderRadius = "5px";
                div.style.height = "125px";
                div.style.padding = "10px";
                div.style.marginTop = "10px";

                // console.log(item);

                const [year, month, day] = item.classdate.split('-');

                // classstart와 classend 시간 변환
                const startTime = new Date(`2000-01-01T${item.classstart}`);
                const endTime = new Date(`2000-01-01T${item.classend}`);
                const startHour = startTime.getHours();
                const startMinute = startTime.getMinutes();
                const endHour = endTime.getHours();
                const endMinute = endTime.getMinutes();

                // 시간 형식 변환 함수
                const formatTime = (hour, minute) => {
                    let period = "오전";
                    let formattedHour = hour;

                    if (hour >= 12) {
                        period = "오후";
                        formattedHour = hour === 12 ? 12 : hour - 12;
                    }

                    return `${period} ${formattedHour}:${String(minute).padStart(2, '0')}`;
                };

                // classlevel 변환 함수
                const getClassLevel = (level) => {
                    switch (level) {
                        case 1:
                            return "입문자";
                        case 2:
                            return "경험자";
                        case 3:
                            return "숙련자";
                        default:
                            return "";
                    }
                };

                div.innerHTML = `<div id="unit-${item.no}">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="width:100%;">
                                            <span style="font-weight: bold; font-size: medium; color: green;">${year}년 ${month}월 ${day}일 (${item.classday.charAt(0)})</span><br />
                                            <span style="font-size: small; color:gray; font-weight: bold;">${formatTime(startHour, startMinute)} ~ ${formatTime(endHour, endMinute)}</span><br>
                                            <div style="display: flex; justify-content: space-between;">
                                                <span style="font-size: small; color: gray; font-weight: bold;">난이도: ${getClassLevel(item.classlevel)}</span>
                                                <span style="font-size: small; color: gray; font-weight: bold; margin-left: auto;">신청인원: ${item.cnt} / ${item.maximum}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-top: 7px;">
                                        <button style="width: 49%; border: 1px solid gray" class="btn btn-sm btn-update" onclick="updateUnit(${classcode}, ${item.no})">수정</button>
                                        <button style="width: 49%; border: 1px solid gray" class="btn btn-sm btn-delete" onclick="deleteUnit(${classcode}, ${item.no})">삭제</button>
                                    </div>
                                </div>`;

                unitList.appendChild(div);
            });

            /***********************************************************************/

            unitList.style.overflow = "auto";
            //unitList.style.maxHeight = "700px";

            // 스크롤 영역의 최대 높이 동적 설정
            function setScrollMaxHeight() {
                const windowHeight = window.innerHeight;
                const topOffset = unitList.getBoundingClientRect().top;
                const marginBottom = 30; // 하단과의 간격을 조정하기 위한 값
                const scrollMaxHeight = windowHeight - topOffset - marginBottom;
                unitList.style.maxHeight = `${scrollMaxHeight}px`;
            }

            // 초기 로드 시 스크롤 영역 높이 설정
            setScrollMaxHeight();

            // 창 크기 변경 시 스크롤 영역 높이 재설정
            window.addEventListener('resize', setScrollMaxHeight);
        }

        /**************************************** 전체 일정 삭제 *****************************************/
        document.getElementById("all_delete").onclick = async function () {
            // 삭제 확인 창 표시
            const confirmMessage = "정말로 전체 일정을 삭제하시겠습니까?";
            if (confirm(confirmMessage)) {
                let url = /*[[@{/api/classunit/deleteall.json}]]*/"";
                url += `?classcode=${ccode}`;
                const body = { classproduct: { classcode: ccode } };
                const headers = { "Content-Type": "application/json" };
                const { data } = await axios.put(url, body, { headers: headers });
                console.log(body);

                if (data.status === 200) {
                    alert("전체 일정 삭제가 완료되었습니다.");
                    const unitList = document.querySelector(".unit-list");
                    unitList.style.display = "none";

                    await selectAll(); // 일정 재조회
                    unitList.style.display = "block"; // 일정 리스트 
                    setTimeout(function() {
                        location.reload();
                    }, 50);
                }
                else {
                    alert("전체 일정 삭제에 실패하였습니다.");
                }
            }
        }

        /******************************** 한 개의 일정 수정 및 삭제 ***************************************/


        // 1. 수정을 위해 먼저 기존 내역 불러오기 위한 GET호출
        async function updateUnit(classcode, no) {
            let url = /*[[@{/api/classunit/selectunitone.json}]]*/"";
            url += `?classcode=${classcode}&no=${no}`;
            const body = { classproduct: { classcode: classcode }, no: no };
            const headers = { "Content-Type": "application/json" };

            const { data } = await axios.get(url, body, { headers: headers });

            // 데이터 불러오기
            document.getElementById('classcode2').value = classcode;
            document.getElementById('unitno2').value = no;
            document.getElementById('minimum2').value = data.obj.minimum;
            document.getElementById('maximum2').value = data.obj.maximum;
            document.getElementById('classdate2').value = data.obj.classdate;
            document.getElementById('classday2').value = data.obj.classday;
            document.getElementById('classstart2').value = data.obj.classstart;
            document.getElementById('classend2').value = data.obj.classend;
            document.getElementById('defaultPrice2').value = data.defaultPrice2;
            document.getElementById('addprice2').value = data.obj.addprice;
            document.getElementById('discount2').value = data.obj.discount;
            document.getElementById('discount_price2').value = data.obj.discount_price;
            var classLevel = parseInt(data.obj.classlevel);
            if (classLevel === 1) {
                document.getElementById('classlevel4').checked = true;
            } else if (classLevel === 2) {
                document.getElementById('classlevel5').checked = true;
            } else if (classLevel === 3) {
                document.getElementById('classlevel6').checked = true;
            }

            // addprice2 입력란 상태 설정
            var addpriceInput = document.getElementById('addprice2');
            if (classLevel === 2 || classLevel === 3) {
                addpriceInput.disabled = false;
            } else {
                addpriceInput.disabled = true;
                addpriceInput.value = '';
            }

            $('#unitUpdateModal').modal('show');
        };

        // 2. 일정수정 유효성 검사
        function updateInspection() {
            const minimum = document.getElementById("minimum2").value;
            const maximum = document.getElementById("maximum2").value;
            const classdate = document.getElementById("classdate2").value;
            const classstart = document.getElementById("classstart2").value;
            const classend = document.getElementById("classend2").value;

            // 필수 입력 항목 확인
            if (!minimum || !maximum || !classdate || !classstart || !classend) {
                alert("필수 입력 항목을 모두 입력해주세요.");
                return;
            }

            // 최소인원 검사
            if (parseInt(minimum) <= 0) {
                alert("최소인원은 0 이상이어야 합니다.");
                return;
            }

            // 최대인원 검사
            if (parseInt(maximum) < parseInt(minimum)) {
                alert("최대인원은 최소인원 이상이어야 합니다.");
                return;
            }

            // 시작시각 및 종료시각 검사
            const startDate = new Date(classdate + " " + classstart);
            const endDate = new Date(classdate + " " + classend);
            if (endDate <= startDate) {
                alert("종료 시각을 시작 시각보다 늦게 설정해주세요.");
                return;
            }

            // 유효성 검사 통과 시 일정 수정 처리
            update();
        }

        // 3. 수정 내용을 변경하기위한 PUT호출
        async function update() {
            const classcode = document.getElementById("classcode2").value;
            const no = document.getElementById("unitno2").value;
            const min = document.getElementById("minimum2").value;
            const max = document.getElementById("maximum2").value;
            const date = document.getElementById("classdate2").value;
            const day = document.getElementById("classday2").value;
            const start = document.getElementById("classstart2").value;
            const end = document.getElementById("classend2").value;
            var level = document.querySelector('input[name="classlevel"]:checked').value;
            const discount = document.getElementById("discount2").value;
            const addprice = document.getElementById("addprice2").value;

            // PUT호출
            const url = /*[[@{/api/classunit/updateone.json}]]*/"";
            const headers = { "Content-Type": "application/json" };
            const body = {
                classproduct: { classcode: classcode },
                no: no,
                minimum: min,
                maximum: max,
                classdate: date,
                classday: day,
                classstart: start,
                classend: end,
                classlevel: level,
                discount: discount,
                addprice: addprice
            };

            console.log(body);
            const { data } = await axios.put(url, body, { headers: headers });
            console.log('반환되는 결과', data);

            if (data.status === 200) {
                alert("일정 변경이 완료되었습니다.")
                $('#unitUpdateModal').modal('hide');
                location.reload();
            }
            else {
                alert("일정 변경에 실패하였습니다.");
            }
        }


        // 할인가만 적용한 계산
        function discountedPrice2() {
            var defaultPrice = parseInt(document.getElementById("defaultPrice2").value);
            var discount = parseInt(document.getElementById("discount2").value);
            var discountedPrice = defaultPrice - (defaultPrice * discount / 100);
            document.getElementById("discount_price2").value = discountedPrice;
        }
        
        // 추가음액과 할인가 적용 계산
        function calculateDiscount2() {
            var defaultPrice = parseInt(document.getElementById("defaultPrice2").value);
            var discount = parseInt(document.getElementById("discount2").value);
            var addPrice = parseInt(document.getElementById("addprice2").value);

            var totalAmount = defaultPrice + addprice;
            var discountAmount = totalAmount * discount / 100;
            var discountPrice = totalAmount - discountAmount;

            if (!addPrice) {
                discountedPrice2(); // 추가금액이 없을 때 할인가만 적용한 계산 수행
              } else {
                var totalAmount = defaultPrice + addPrice;
                var discountAmount = totalAmount * (discount / 100);
                var discountPrice = totalAmount - discountAmount;
            
                document.getElementById("discount_price2").value = discount ? discountPrice : totalAmount;
            }
        }

        // 추가금액 입력값 변경 시 할인 계산 수행
        document.getElementById("addprice2").addEventListener("input", calculateDiscount2);

        // 할인 비율 변경 시 할인 계산 수행
        document.getElementById("discount2").addEventListener("input", calculateDiscount2);

        // 할일 비율 설정시 체크 후 입력란 활성화
        function toggleDiscountInput2() {
            var discountCheckbox = document.getElementById("discount-chk2");
            var discountInput = document.getElementById("discount2");
            var discountPriceInput = document.getElementById("discount_price2");

            if (discountCheckbox.checked) {
                discountInput.disabled = false;
                discountInput.value = "";
                discountPriceInput.value = "";
            } else {
                discountInput.disabled = true;
                discountInput.value = "";
                discountPriceInput.value = "";
            }
        }

        // 클래스 난이도별 추가 금액 입력란 활성화
        var radioBtns2 = document.querySelectorAll('.radio-value');
        function handleRadioClick2() {
            var addpriceInput = document.getElementById('addprice2');
            var level = document.querySelector('input[name="classlevel"]:checked').value;
            addpriceInput.disabled = !(level === '2' || level === '3');
            addpriceInput.value = '';
        }

        radioBtns2.forEach(function (radioBtn2) {
            radioBtn2.addEventListener('click', handleRadioClick2);
        });

        // 난이도 체크가 변경될 때 discount_price2 초기화
        $(document).ready(function() {
            $('input[name="classlevel"]').change(function() {
                $('#discount_price2').val('');

                var isChecked = $(this).prop('checked');
                if (isChecked) {
                    $('#discount-chk2').prop('checked', false);
                    $('#discount2').val('');
                    $('#discount2').prop('disabled', true);
                } else {
                    $('#discount-chk2').prop('checked', true);
                }
            });
        });

        //모달 창 닫힐 때 초기화 함수 호출
        $('#unitUpdateModal').on('hidden.bs.modal', function () {
            resetModalInputs2();
        });

        function resetModalInputs2() {
            document.getElementById("discount-chk2").checked = false;
            document.getElementById("discount2").disabled = true;
        }

        // 모달 닫기
        function cancel2() {
            $('#unitUpdateModal').modal('hide');
        }

        // 일정 하나 삭제
        async function deleteUnit(classcode, no, cnt, chk) {

            if (cnt > 0 && chk == 1) {
                alert("신청 인원이 있어 삭제가 불가능합니다.");
                return false;
            }

            if (confirm("정말 삭제하시겠습니까?")) {

                let url = /*[[@{/api/classunit/deleteone.json}]]*/"";
                url += `?classcode=${classcode}&no=${no}`;
                const body = {
                    classproduct: { classcode: classcode },
                    no: no
                };
                const headers = { "Content-Type": "application/json" };
                const { data } = await axios.put(url, body, { headers: headers });
                console.log("classcode:", classcode, "no:", no);

                if (data.status === 200) {
                    alert("삭제가 완료되었습니다.");
                    const deletedUnit = document.getElementById(`unit-${no}`);
                    if (deletedUnit) {
                        const parentDiv = deletedUnit.parentElement;
                        if (parentDiv) {
                            parentDiv.style.border = "none";
                            parentDiv.style.backgroundColor = "transparent";
                            parentDiv.style.height = "0";
                            parentDiv.style.padding = "0";
                            parentDiv.style.marginTop = "0";
                        }
                        deletedUnit.remove();
                    }
                    setTimeout(function() {
                        location.reload();
                    }, 50);
                }
                else {
                    alert("삭제에 실패하였습니다.");
                }
            }

        };

    </script>


</div>